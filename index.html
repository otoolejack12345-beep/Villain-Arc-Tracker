<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Villain Arc Tracker</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a1f44">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { margin:0; font-family:sans-serif; background:#0a1f44; color:#fff; }
.tab-bar { display:flex; justify-content:space-around; position:fixed; bottom:0; width:100%; background:#081634; }
.tab { padding:15px; flex:1; text-align:center; cursor:pointer; }
.tab.active { background:#12295e; }
.page { display:none; padding:20px; padding-bottom:70px; }
.page.active { display:block; }
#xpBar { width:100%; background:#12295e; height:20px; border-radius:10px; margin:10px 0; }
#xpFill { height:100%; background:#00ff00; width:0%; border-radius:10px; }
input, button { margin:5px 0; padding:5px; }
canvas { background:#081634; border-radius:10px; margin-top:10px; }
button { cursor:pointer; }
</style>
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js')
  .then(()=>console.log('Service Worker Registered'))
  .catch(err=>console.log('SW registration failed:', err));
}
</script>
</head>
<body>

<!-- Dashboard Page -->
<div id="dashboard" class="page active">
  <h2>Villain Dashboard</h2>
  <img id="avatar" src="icon.png" alt="Avatar" width="100">
  <p>Name: <span id="villainNameDisplay"></span></p>
  <p>Level: <span id="levelDisplay"></span></p>
  <p>XP: <span id="xpDisplay"></span> / <span id="xpNextDisplay"></span></p>
  <div id="xpBar"><div id="xpFill"></div></div>
  <p>Weight: <span id="weightDisplay"></span> lbs / Goal: <span id="goalWeightDisplay"></span> lbs</p>
  <p>Calories Today: <span id="caloriesTodayDisplay"></span> (Net: <span id="netCaloriesDisplay"></span>) / Goal: <span id="dailyCaloriesDisplay"></span></p>
  <p>Calories Remaining: <span id="caloriesRemainingDisplay"></span></p>

  <h3>Calories Progress</h3>
  <canvas id="caloriesChart"></canvas>

  <h3>Projected Weight Loss (next 30 days)</h3>
  <canvas id="projectedChart"></canvas>
</div>

<!-- Calories Page -->
<div id="caloriesPage" class="page">
  <h2>Log Calories</h2>
  <input type="text" id="mealName" placeholder="Meal Name">
  <input type="number" id="mealCalories" placeholder="Calories">
  <button onclick="addMeal()">Add Meal</button>
  <ul id="mealList"></ul>

  <h3>Calories Burned</h3>
  <input type="number" id="burnedCalories" placeholder="Calories Burned">
  <button onclick="addBurned()">Add Burned Calories</button>
  <p>Total Burned Today: <span id="burnedTodayDisplay"></span></p>
</div>

<!-- Weight Tracker Page -->
<div id="weightPage" class="page">
  <h2>Weight Tracker</h2>
  <input type="number" id="weightInput" placeholder="Today's weight">
  <button onclick="addWeight()">Add Weight</button>
  <canvas id="weightChart"></canvas>
</div>

<!-- Goals Page -->
<div id="goalsPage" class="page">
  <h2>Set Goals</h2>
  <input type="text" id="villainName" placeholder="Villain Name">
  <input type="number" id="goalWeight" placeholder="Goal Weight">
  <input type="number" id="maintenanceCalories" placeholder="Daily Maintenance Calories">
  <input type="number" id="dailyCalories" placeholder="Daily Goal Calories">
  <input type="number" id="height" placeholder="Height (inches)">
  <input type="number" id="age" placeholder="Age">
  <button onclick="saveGoals()">Save Goals</button>
</div>

<!-- Tab Bar -->
<div class="tab-bar">
  <div class="tab active" onclick="showPage('dashboard', event)">Dashboard</div>
  <div class="tab" onclick="showPage('caloriesPage', event)">Calories</div>
  <div class="tab" onclick="showPage('weightPage', event)">Weight</div>
  <div class="tab" onclick="showPage('goalsPage', event)">Goals</div>
</div>

<script>
let todayDate = new Date().toLocaleDateString();
let villainData = JSON.parse(localStorage.getItem('villainData')) || {
  villainName: 'Dark Villain',
  level: 1,
  xp: 0,
  xpToNextLevel: 100,
  caloriesToday:0,
  burnedToday:0,
  maintenanceCalories: 2500,
  dailyCalorieGoal:2000,
  weight:277,
  goalWeight:180,
  meals:[],
  weights:[],
  height:73,
  age:19
};

// Reset daily calories if a new day
if(villainData.lastUpdate !== todayDate){
  villainData.caloriesToday = 0;
  villainData.burnedToday = 0;
  villainData.lastUpdate = todayDate;
  saveData();
}

// Tab switching
function showPage(id,event){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  event.currentTarget.classList.add('active');
}

// Save data
function saveData(){ localStorage.setItem('villainData', JSON.stringify(villainData)); }

// XP based on weight loss
function updateXPByWeight() {
  const startWeight = 277;
  const step = 10;
  let lost = startWeight - villainData.weight;
  if (lost < 0) lost = 0;
  let level = Math.floor(lost / step) + 1;
  villainData.level = level;
  let xpInStep = lost % step;
  villainData.xp = xpInStep * 10;
  villainData.xpToNextLevel = step * 10;
  saveData();
  updateDisplay();
}

// Add meal
function addMeal(){
  let name=document.getElementById('mealName').value;
  let c=parseInt(document.getElementById('mealCalories').value);
  if(name && c){
    villainData.meals.push({name,c,date:todayDate});
    villainData.caloriesToday+=c;
    saveData();
    renderMeals();
    updateDisplay();
    updateCharts();
  }
}
function renderMeals(){
  let ul=document.getElementById('mealList');
  ul.innerHTML='';
  villainData.meals.forEach((m,index)=>{
    let li=document.createElement('li');
    li.textContent=`${m.name}: ${m.calories} cal `;
    let delBtn=document.createElement('button');
    delBtn.textContent='Remove';
    delBtn.style.marginLeft='10px';
    delBtn.onclick=()=>removeMeal(index);
    li.appendChild(delBtn);
    ul.appendChild(li);
  });
}
function removeMeal(index){
  let meal=villainData.meals[index];
  villainData.caloriesToday-=meal.calories;
  villainData.meals.splice(index,1);
  saveData();
  renderMeals();
  updateDisplay();
  updateCharts();
}

// Add burned calories
function addBurned(){
  let burned=parseInt(document.getElementById('burnedCalories').value);
  if(!burned) return;
  villainData.burnedToday+=burned;
  saveData();
  updateDisplay();
  updateCharts();
}

// Add weight
function addWeight(){
  let w = parseFloat(document.getElementById('weightInput').value);
  if(!w) return;
  villainData.weight = w;
  villainData.weights.push({date:todayDate, weight: w});
  updateXPByWeight();
  saveData();
  updateCharts();
  updateDisplay();
}

// Charts
let weightChart=new Chart(document.getElementById('weightChart'),{
  type:'line',
  data:{labels:[], datasets:[{label:'Weight',data:[], borderColor:'lime', fill:false}]},
  options:{scales:{y:{beginAtZero:false}}}
});
let projectedChart=new Chart(document.getElementById('projectedChart'),{
  type:'line',
  data:{labels:[], datasets:[{label:'Projected Weight',data:[], borderColor:'yellow', fill:false}]},
  options:{scales:{y:{beginAtZero:false}}}
});
let caloriesChart=new Chart(document.getElementById('caloriesChart'),{
  type:'line',
  data:{labels:[], datasets:[{label:'Calories Consumed', data:[], borderColor:'orange', fill:false},{label:'Daily Goal', data:[], borderColor:'green', fill:false}]},
  options:{scales:{y:{beginAtZero:true}}}
});

// Update all charts
function updateCharts(){
  updateWeightChart();
  updateProjectedChart();
  updateCaloriesChart();
}

// Weight chart
function updateWeightChart(){
  let labels=villainData.weights.map(w=>w.date);
  let data=villainData.weights.map(w=>w.weight);
  weightChart.data.labels=labels;
  weightChart.data.datasets[0].data=data;
  weightChart.update();
}

// Projected weight
function updateProjectedChart(){
  let labels=[], data=[];
  let currentWeight=villainData.weight || 277;
  let goalWeight=villainData.goalWeight || 180;
  let maintenance=villainData.maintenanceCalories || 2500;
  let dailyGoal=villainData.dailyCalorieGoal || 2000;

  let projectedWeight = currentWeight;

  // Past logged days
  let mealsByDate = {};
  villainData.meals.forEach(m=>{
    if(!mealsByDate[m.date]) mealsByDate[m.date]=0;
    mealsByDate[m.date]+=m.calories;
  });

  let datesLogged = Object.keys(mealsByDate).sort((a,b)=>new Date(a)-new Date(b));
  datesLogged.forEach(date=>{
    let deficit = maintenance - mealsByDate[date];
    deficit += villainData.burnedToday; // subtract burned calories for today
    if(deficit < 0) deficit=0;
    projectedWeight -= deficit/3500;
    if(projectedWeight < goalWeight) projectedWeight=goalWeight;
    labels.push(date);
    data.push(projectedWeight.toFixed(1));
  });

  // Future days projection
  for(let i=1;i<=30;i++){
    let futureDate = new Date();
    futureDate.setDate(futureDate.getDate()+i);
    let deficit = maintenance - dailyGoal;
    if(deficit <0) deficit=0;
    projectedWeight -= deficit/3500;
    if(projectedWeight < goalWeight) projectedWeight = goalWeight;
    labels.push(futureDate.toLocaleDateString());
    data.push(projectedWeight.toFixed(1));
  }

  projectedChart.data.labels = labels;
  projectedChart.data.datasets[0].data = data;
  projectedChart.update();
}

// Calories progress chart
function updateCaloriesChart(){
  let labels = ['Today'];
  let consumed = [villainData.caloriesToday];
  let goal = [villainData.dailyCalorieGoal];
  caloriesChart.data.labels = labels;
  caloriesChart.data.datasets[0].data = consumed;
  caloriesChart.data.datasets[1].data = goal;
  caloriesChart.update();
}

// Save goals
function saveGoals(){
  let name=document.getElementById('villainName').value;
  let goalW=parseFloat(document.getElementById('goalWeight').value);
  let maintenance=parseInt(document.getElementById('maintenanceCalories').value);
  let dailyGoal=parseInt(document.getElementById('dailyCalories').value);
  let h=parseInt(document.getElementById('height').value);
  let a=parseInt(document.getElementById('age').value);

  if(name) villainData.villainName=name;
  if(goalW) villainData.goalWeight=goalW;
  if(maintenance) villainData.maintenanceCalories=maintenance;
  if(dailyGoal) villainData.dailyCalorieGoal=dailyGoal;
  if(h) villainData.height=h;
  if(a) villainData.age=a;

  saveData();
  updateDisplay();
  updateCharts();
}

// Dashboard display
function updateDisplay(){
  document.getElementById('villainNameDisplay').textContent=villainData.villainName;
  document.getElementById('levelDisplay').textContent=villainData.level;
  document.getElementById('xpDisplay').textContent=villainData.xp;
  document.getElementById('xpNextDisplay').textContent=villainData.xpToNextLevel;
  document.getElementById('xpFill').style.width=`${(villainData.xp/villainData.xpToNextLevel)*100}%`;
  document.getElementById('caloriesTodayDisplay').textContent=villainData.caloriesToday;
  let net = villainData.caloriesToday - villainData.burnedToday;
  document.getElementById('netCaloriesDisplay').textContent=net;
  document.getElementById('caloriesRemainingDisplay').textContent = Math.max(villainData.dailyCalorieGoal - net,0);
  document.getElementById('dailyCaloriesDisplay').textContent=villainData.dailyCalorieGoal;
  document.getElementById('weightDisplay').textContent=villainData.weight;
  document.getElementById('goalWeightDisplay').textContent=villainData.goalWeight;
  document.getElementById('burnedTodayDisplay').textContent=villainData.burnedToday;
  renderMeals();
}

updateDisplay();
updateCharts();
</script>
</body>
</html>
